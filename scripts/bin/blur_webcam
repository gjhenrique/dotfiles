#! /usr/bin/python

import os
import subprocess
import re
import psutil
import pyfakewebcam
import numpy as np
import time

# https://github.com/fangfufu/Linux-Fake-Background-Webcam is the service that blurs webcams
# The issue is that it wastes CPU and leaves the webcam light always turned on
# I need a way to start this service only when I'm on a meeting and turn off automatically when I'm off

# This script does 2 checks: Check if program fake.py is running and
# If fake.py is not running and a new meeting is detected, then fake.py is spawned
# If fake.py is running and a meeting is over, then fake.py is killed
BLUR_PATH = '~/Projects/python/Linux-Fake-Background-Webcam'
WIDTH = 640
HEIGHT = 480
COMMAND = 'swaymsg -t get_tree  | jq ".. | .name? // empty" | grep -E "Zoom Meeting|Slack call"'

def check_if_in_meeting():
    code = subprocess.run(COMMAND, shell=True, check=False).returncode
    return not bool(code)


def blur_process():
    processes = [proc for proc in psutil.process_iter() if re.search('fake.py', ' '.join(proc.cmdline()))]
    return processes[0] if len(processes) > 0 else None


# Change workdir to blur script
os.chdir(os.path.expanduser(BLUR_PATH))
cwd = os.getcwd()

fake_cam = pyfakewebcam.FakeWebcam('/dev/video2', WIDTH, HEIGHT)

frame = np.zeros((HEIGHT, WIDTH, 3), dtype=np.uint8)
frame[:, :, :3] = 255
while True:
    in_meeting = check_if_in_meeting()
    process = blur_process()

    if(not in_meeting and process):
        print("Killing")
        os.kill(process.pid, 3)

    if(in_meeting and not process):
        print('Spawning')
        command = f'python3 fake.py --no-foreground --no-background --background-blur 100 --width {WIDTH} --height {HEIGHT}'
        subprocess.Popen(command, shell=True)

    if not in_meeting:
        fake_cam.schedule_frame(frame)

    time.sleep(5)
